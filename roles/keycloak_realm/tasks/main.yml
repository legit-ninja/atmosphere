# Copyright (c) 2023 VEXXHOST, Inc.
#
# Licensed under the Apache License, Version 2.0 (the "License"); you may
# not use this file except in compliance with the License. You may obtain
# a copy of the License at
#
#      http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS, WITHOUT
# WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the
# License for the specific language governing permissions and limitations
# under the License.


- name: Create realms
  # Note(okozachenko1203): Ignoring changes in this task until the upstream issue
  #                        https://github.com/keycloak/keycloak/issues/20970 is resolved.
  changed_when: false
  community.general.keycloak_realm:
    auth_client_id: admin-cli
    auth_keycloak_url: "https://{{ keycloak_host }}"
    auth_realm: master
    auth_username: "{{ keycloak_realm_admin_username }}"
    auth_password: "{{ keycloak_realm_admin_password }}"
    id: "{{ keycloak_realm_id }}"
    realm: "{{ keycloak_realm_name | default(keycloak_realm_id) }}"
    enabled: true
  retries: 60
  delay: 5
  register: keycloak_realm_result
  until: keycloak_realm_result is not failed

- name: Include client roles in id token
  community.general.keycloak_clientscope:
    auth_client_id: admin-cli
    auth_keycloak_url: "https://{{ keycloak_host }}"
    auth_realm: master
    auth_username: "{{ keycloak_realm_admin_username }}"
    auth_password: "{{ keycloak_realm_admin_password }}"
    realm: "{{ keycloak_realm_id }}"
    name: roles
    protocol_mappers:
      - name: client roles
        protocol: openid-connect
        protocolMapper: oidc-usermodel-client-role-mapper
        config:
          id.token.claim: true
          access.token.claim: true
          claim.name: "resource_access.${client_id}.roles"
          multivalued: true
